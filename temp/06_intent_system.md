# Intent System in Fractal Network

**Last Updated: May 30, 2025**

## Overview

The Intent System is a crucial component of the Fractal Network, enabling users (via Agents) to express their desired actions or state changes. These intents are generated by Agents, signed, and then submitted to the Custodian network. Custodians, through the `IntentProcessing` module, are responsible for validating these intents, managing an auction for their inclusion in blocks, executing them within a WASM environment, and ensuring the results are consistently applied and proven.

**The introduction of Agent operational modes (Explorer, Operator, Guardian, Hybrid) as detailed in `08_economic_model.md` impacts how Agents interact with the intent system, particularly concerning access rights and potential fee exemptions or differing priorities.**

While Taproot was initially considered for intent structure to enhance privacy and flexibility, the current implementation (as of May 2025) uses a more direct approach with standard Ed25519 signatures for intent authenticity and integrity. The core logic for intent execution resides in WASM modules.

## Intent Generation by Agents

- **Agents**: User-controlled applications on various devices (mobile, PC, IoT) that construct and sign intents. **The Agent's operational mode (Explorer, Operator, Guardian, Hybrid) may influence the types of intents it can generate or the resources (e.g., $SOLV for fees) it has available.**
- **Intent Structure**: An `Intent` (as defined in `IntentProcessing/internal/domain/entity/intent.go`) typically includes:
    - `ID`: A unique identifier (UUID) for the intent.
    - `AgentID`: The identifier of the originating Agent.
    - `AgentPubKey`: The Ed25519 public key of the Agent, used for signature verification.
    - `Nonce`: A sequential number to prevent replay attacks, specific to the Agent.
    - `WASMModuleID`: Identifier for the WASM module that contains the logic for this intent type.
    - `Function`: The specific function name within the WASM module to be executed.
    - `Args`: The arguments (as `[]byte`) to be passed to the WASM function.
    - `MaxFeeSOLV`: The maximum fee in $SOLV the Agent is willing to pay for processing. **This is primarily relevant for Agents in Operator or Hybrid mode, or Explorers exceeding free tier limits. Guardians operating under the work-contribution model might have different fee considerations or exemptions, governed by the economic model.**
    - `GasLimit`: The maximum computational units (gas) the Agent allocates for execution.
    - `Signature`: An Ed25519 signature generated by the Agent over the canonical representation of the intent fields (excluding the signature itself).
    - `ReceivedAt`: Timestamp of when the intent was received by a Custodian (added by the Custodian).
    - `PriorityScore`: Calculated by Custodians for auctioning purposes. **The Agent's operational mode or reputation (especially for Guardians) might influence this score.**
- **Signing**: Agents use their private Ed25519 key to sign the intent. The `Cryptography` module provides the necessary Ed25519 signing functions.

## Intent Processing Workflow by Custodians (via `IntentProcessing` Module)

1.  **Reception**: Custodians receive serialized intents from Agents (e.g., via the `P2P` module). The `IntentReceiverService` in the `IntentProcessing` module handles deserialization and initial handoff.

2.  **Validation (`IntentValidationService`)**: Each intent undergoes a rigorous validation process:
    *   **Stateless Validation**:
        *   Proper formatting and structural integrity.
        *   Valid Ed25519 signature against `AgentPubKey` and intent data.
        *   Intent size within `MaxIntentSizeKB`.
        *   `MaxFeeSOLV` meets `MinRequiredFeeSOLV` **(this check might be conditional based on Agent mode, e.g., Guardians might have different fee requirements or exemptions).**
        *   `GasLimit` is within acceptable network-defined bounds.
    *   **Stateful Validation** (requires querying repository state):
        *   `Nonce` verification against the Agent's current nonce (`AgentStateRepository`).
        *   **(Conceptual: Agent balance check against `MaxFeeSOLV` - would involve `Economics` module, primarily for Operator/Hybrid modes).**
        *   **Verification of Agent's operational mode and associated permissions/limits (e.g., daily intent limits for Explorers, task eligibility for Guardians if the intent relates to a Guardian task). This would involve querying Agent state, potentially managed by `AgentCore` or a shared state repository.**
        *   Existence and integrity of the specified `WASMModuleID` (`WASMModuleRepository`).
        *   Intent age check against `MaxIntentAgeForValidation`.
    *   Intents failing validation are rejected.

3.  **Storage & Auctioning (`IntentAuctionService`, `IntentRepository`)**:
    *   Valid intents are stored in an `IntentRepository` (currently in-memory).
    *   A `PriorityScore` is calculated for each intent (e.g., based on `MaxFeeSOLV`, age, **and potentially Agent mode/reputation, especially for Guardians or Hybrid agents to reflect their contribution or status**).
    *   The `IntentAuctionService` selects intents for block inclusion based on this priority score and configuration like `MaxAuctionIntents`. This is a simplified auction; future versions may adopt more complex SUAVE-style mechanisms.

4.  **Execution (`WASMExecutionService`, `WASMExecutor`)**:
    *   Selected intents are passed to the `WASMExecutionService`.
    *   The service retrieves the specified WASM module (`WASMModuleRepository`).
    *   A sandboxed WASM execution environment is prepared (e.g., using Wazero via `WazeroExecutor`).
        *   Gas limits are enforced.
        *   Host functions are provided for the WASM module to interact with Custodian-managed state (e.g., read/propose updates to `AgentStateRepository`, log messages). These are defined in `WASMExecutor` implementations like `wasm.WazeroExecutionContext`.
    *   The specified `Function` in the WASM module is called with `Args`.
    *   Execution results are collected: return value, proposed state changes (e.g., CRDT updates for Agent nonce), actual gas used, and any errors.

5.  **Fee Calculation (`FeeCalculationService`)**:
    *   The `ActualFeeSOLV` is calculated based on `GasUsed` and network fee parameters (e.g., `BaseFeePerGas`).

6.  **Result Handling & State Commitment (Conceptual / Future)**:
    *   Execution results (including `ActualFeeSOLV` and proposed state changes) are recorded (`ExecutionResultRepository`).
    *   Proposed state changes (e.g., nonce updates) are applied.
    *   For a batch of intents processed by `DAGConsensus`, an aggregated state commitment (e.g., Merkle root of state changes, ZK proof of valid execution) would be generated and anchored.
    *   `TraceLinkProof`s generated during WASM execution would be collected for the `TraceMerkleTrie` via `CustodianServices`.

## Data Flow & State Updates

- **Agent Micro-Ledger Updates**: Intent execution (via WASM host functions) proposes updates to the Agent's micro-ledger (e.g., incrementing nonce, changing application-specific state). These are currently applied to an in-memory `AgentStateRepository`.
- **Proof Generation**: While ZKPs for individual intent executions are not yet fully implemented in `IntentProcessing`, the architecture anticipates that WASM modules can request ZK proof generation via host functions (interfacing with the `ZKProofs` module). Aggregated proofs of execution for batches of intents are also a future goal.

## Security Considerations

- **Intent Signing**: Ed25519 signatures ensure authenticity and integrity.
- **Nonce Mechanism**: Protects against replay attacks.
- **Input Validation**: Rigorous validation by `IntentValidationService` is critical to prevent malformed or malicious intents.
- **WASM Sandboxing**: The `WASMExecutor` (e.g., Wazero) must provide strong isolation and resource control (gas, memory, execution time) to prevent DoS or exploits from WASM modules.
- **Host Function Security**: Host functions exposed to WASM must be carefully designed and restricted.
- **Fee Market & DoS**: Gas limits and fees help mitigate spam and DoS. The auction mechanism aims for fair resource allocation. **The F2P-inspired model with different Agent modes (Explorer limits, Guardian contributions) introduces new dynamics to DoS mitigation and resource allocation that need careful consideration and balancing.**
- **Deterministic Execution**: WASM execution must be deterministic for consistent results across Custodians.

## Conclusion

The Intent System, primarily managed by the `IntentProcessing` module on the Custodian side, provides a structured and secure way for Agents to interact with the Fractal Network. **The integration of Agent operational modes (Explorer, Operator, Guardian, Hybrid) adds a new layer of complexity and flexibility, allowing for different access tiers and contribution-based participation.** The current implementation (May 2025) has established the core pipeline for intent reception, validation, priority-based auctioning, and WASM-based execution with in-memory state. Future development will focus on persistent storage, advanced auction mechanisms, deeper integration with other modules like `Economics` (to fully realize the F2P model, fee structures, and Guardian rewards/verification) and `ZKProofs`, and robust state commitment for `DAGConsensus`.